---
title: '10 Multiple Regression Analysis: Further Issues'
author: "Mohammadamin Firouzi"
date: "2025-04-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Multiple Regression Analysis: Further Issues

#### Quadratics and Polynomials:

```{r message=FALSE, warning=FALSE}

library('wooldridge')
library('AER')

data(wage1)
attach(wage1)
reg1 = lm(wage ~ exper)
summary(reg1)

# install.packages("marginaleffects")
library(marginaleffects)

(marginatmean = slopes(reg1, newdata = datagrid()))
margin = slopes(reg1)
head(margin)
mean(margin$estimate[margin$term == 'exper'])

plot(wage ~ exper, pch = 20, col = 'steelblue',
     xlab = 'Experience in years',
     ylab = 'Wage in $',
     main = 'Wage vs Experience')
abline(reg1, col = 'red', lwd = 3)

reg2 = lm(wage ~ exper + expersq)
summary(reg2)

plot(wage ~ exper, pch = 20, col = 'steelblue',
     xlab = 'Experience in years',
     ylab = 'Wage in $',
     main = 'Wage vs Experience')
abline(reg1, col = 'red', lwd = 3)
abline(reg2, col = 'green', lwd = 3)
legend('topright', legend = c('Linear fit', 'Quadratic fit'),
       lwd = 2, col = c('red', 'green'))

(marginatmean2 = slopes(reg2, newdata = datagrid()))
margin2 = slopes(reg2)

reg3 = lm(wage ~ exper + I(exper^2))
summary(reg3)
(marginatmean3 = slopes(reg3, newdata = datagrid()))
margin3 = slopes(reg3)
mean(margin3$estimate[margin3$term == 'exper'])

plot(wage ~ exper, pch = 20, col = 'steelblue',
     xlab = 'Experience in years',
     ylab = 'Wage in $',
     main = 'Wage vs Experience')
abline(reg1, col = 'red', lwd = 3)
order_id = order(exper)
lines(x = exper[order_id],
      y = fitted(reg3)[order_id],
      col = 'green',
      lwd = 3)
legend('topright', legend = c('Linear fit', 'Quadratic fit'),
       lwd = 2, col = c('red', 'green'))

reg4 = lm(wage ~ poly(exper, 3, raw = TRUE))
summary(reg4)

detach(wage1)

```

#### Logarithmic model:

```{r message=FALSE, warning=FALSE}

data("CASchools")
CASchools$score = (CASchools$math + CASchools$read)/2
attach(CASchools)
```

Case I: X is in Logarithm, y is not:

```{r message=FALSE, warning=FALSE}

score_vs_lincome = lm(score ~ log(income))
summary(score_vs_lincome)
```

We can interpret $\beta_1$ as follows: a 1% increase in income is associated with an increase in test scores of 0.01 ×36.42 = 0.36 points.

```{r message=FALSE, warning=FALSE}

plot(x = income, y = score, pch = 20, col = 'steelblue',
     main = 'Linear-log regression line',
     xlab = 'Income', ylab = 'Score', cex = 1)
order_id = order(income)
lines(income[order_id], fitted(score_vs_lincome)[order_id],
     col = 'red', lwd = 2)
legend("bottomright", legend = "Linear-log line", lwd = 2, col = 'red')

new_data = data.frame(income = c(10, 11, 40, 41))
y_hat = predict(score_vs_lincome, newdata = new_data)
y_hat_matrix = matrix(y_hat, nrow = 2, byrow = TRUE)
y_hat_matrix[, 2] - y_hat_matrix[, 1]
```

Case II: y is in Logarithm, X is not:

```{r message=FALSE, warning=FALSE}

lscore_vs_income = lm(log(score) ~ income)
summary(lscore_vs_income)
```

An increase in district income by \$1000 is expected to increase test scores by 100 × 0.00284% = 0.284%.

Case III: Both y and X are in Logarithm:

```{r message=FALSE, warning=FALSE}

lscore_vs_lincome = lm(log(score) ~ log(income))
summary(lscore_vs_lincome)
```

In a log-log model,a 1% change in X is associated with an estimated $\beta_1$%change in Y.

#### Interaction Terms:

```{r message=FALSE, warning=FALSE}

data(wage1)
attach(wage1)

regression = lm(wage ~ educ + female * married)
summary(regression)

library(ggplot2)

wage1$group = interaction(female, married)
wage1$group = factor(wage1$group,
                          levels = c("0.0", "0.1", "1.0", "1.1"),
                          labels = c("Male, Single", "Male, Married",
                                     "Female, Single", "Female, Married"))
wage1$predicted = predict(regression)

ggplot(wage1, aes(x = educ, y = wage, color = group)) +
  geom_point() +
  geom_line(aes(y = predicted), size = 1) +
  labs(title = 'Wage vs Education by Gender and Marital Status',
       x = 'Education',
       y = 'Wage',
       color = 'Group') +
  theme_minimal()
```

#### Prediction:

```{r message=FALSE, warning=FALSE}

values = data.frame(educ = c(12, 10, 5), female = c(1, 0, 1), married = c(0, 1, 0))
predict(regression, values)
predict(regression, values, interval = 'confidence')
predict(regression, values, interval = 'confidence', level = 0.95)
predict(regression, values, interval = 'confidence', level = 0.99)
```
