---
title: Instrumental Variables Estimation and Two Stage Least Squares
author: "Mohammadamin Firouzi"
date: "2025-08-17"
---

# Instrumental Variables Estimation and Two Stage Least Squares

```{r, warning=FALSE, message = FALSE}

library(AER); library(stargazer); library(car)
data(mroz, package = 'wooldridge')

smpl = subset(mroz, !is.na(wage))
```

#### OLS coefficients manually

```{r, warning=FALSE, message = FALSE}

(bols = with(smpl, cov(log(wage), educ) / var(educ)))
(aols = with(smpl, mean(log(wage)) - bols * mean(educ)))
```

#### IV coefficients manually

```{r, warning=FALSE, message = FALSE}

(biv = with(smpl, cov(log(wage), fatheduc) / cov(educ, fatheduc)))
(aiv = with(smpl, mean(log(wage)) - biv * mean(educ)))
```

#### OLS and IV automatically

```{r, warning=FALSE, message = FALSE}

olsreg = lm(log(wage) ~ educ, smpl)
ivregg =  ivreg(log(wage) ~ educ | fatheduc, data = smpl)

se = list(
  sqrt(diag(vcov(olsreg))), 
  sqrt(diag(vcovHC(olsreg, type = "HC1"))),
  sqrt(diag(vcov(ivregg))), 
  sqrt(diag(vcovHC(ivregg, type = "HC1")))
)

stargazer(olsreg, olsreg_rob, ivregg, ivregg_rob,
          se = se,
          type = 'text', title = "OLS and IV Estimates with Regular and Robust SEs",
          column.labels = c("OLS", "OLS Robust", "IV", "IV Robust"),
          column.separate = c(1, 1, 1, 1),
          keep.stat = c("n", "rsq"),
          align = TRUE, model.names = FALSE, model.numbers = FALSE
          )
```

#### More exogenous regressors

```{r, warning=FALSE, message = FALSE}

data(card, package = 'wooldridge')
redf = lm(educ ~ nearc4 + exper + I(exper^2) + black + smsa
        + south + smsa66 + reg662 +
        reg663 + reg664 + reg665 + reg666 + reg667 + reg668 + reg669,
        data = card) 
summary(redf)

```

Check for relevance. nearc4 parameter is highly significantly different from zero, so relevance is supported.

```{r, warning=FALSE, message = FALSE}

ols = lm(log(wage) ~ educ + exper + I(exper^2) + black +
           smsa + south + smsa66 + reg662 +
           reg663 + reg664 + reg665 + reg666 +
           reg667 + reg668 + reg669, card)

iv = ivreg(log(wage) ~ educ + exper + I(exper^2) + black +
            smsa + south + smsa66 + reg662 + reg663 +
            reg664 + reg665 + reg666 + reg667 + reg668 + reg669
           | nearc4 + exper + I(exper^2) + black + smsa + south
           + smsa66 + reg662 + reg663 + reg664 + 
             reg665 + reg666 + reg667 + reg668 + reg669,
          data = card)

# Alternative:

iv_alternative = ivreg(log(wage) ~ educ + exper + I(exper^2) + black +
                 smsa + south + smsa66 + reg662 + reg663 +
                 reg664 + reg665 + reg666 + reg667 + reg668 + reg669
               | . - educ + nearc4,
               data = card)

stargazer(ols, iv, iv_alternative, type = 'text')

coeftest(iv, vcov = vcovHC(iv, type = 'HC1'))
```

#### 2SLS

```{r, warning=FALSE, message = FALSE}

fs = lm(educ ~ exper + I(exper ^ 2) + motheduc + fatheduc, smpl)# first stage
smpl$fs_hat <- fitted(fs)

ss = lm(log(wage) ~ fs_hat + exper + I(exper ^ 2), smpl) # second stage
twosls = ivreg(log(wage) ~ educ + exper + I(exper ^ 2) |
                 motheduc + fatheduc + exper + I(exper ^ 2), data = smpl)

stargazer(ss, twosls, type = 'text')
```

#### Testing for exogeneity of the regressors

(1) Like in 2SLS, regress y2 and y3 on z1 through z5. Obtain residuals v_2 and v_3 instead of fitted values.
(2) Regress y1 on y2, y3, z1, z2, z3, and the first stage residuals v_2 and v_3.

```{r, warning=FALSE, message = FALSE}

stage1 = lm(educ ~ exper + I(exper^2) + motheduc + fatheduc, data = smpl)
stage2 = lm(log(wage) ~ educ + exper + I(exper^2) + resid(stage1), data = smpl)

summary(stage2)
```

Here, t = 1.6711 with a two-sided p value of p = 0.095, indicating a marginally significant evidence for endogeneity.

#### Testing overidentifying restrictions

```{r, warning=FALSE, message = FALSE}

reg.2sls = ivreg(log(wage) ~ educ + exper + I(exper^2) |
                   exper + I(exper^2) + motheduc + fatheduc, data = smpl)
reg.aux = lm(resid(reg.2sls) ~ exper + I(exper^2) + motheduc + fatheduc, 
             data =smpl)
test = linearHypothesis(reg.aux, c('fatheduc = 0', 'motheduc = 0'),
                        test = 'Chisq')
test
pchisq(test[2, 5], df = 1, lower.tail = FALSE)
```

Since this value is bigger than 0.05 we can't reject the hypothesis that both instruments are exogenous at the level of 5%.

```{r, warning=FALSE, message = FALSE}

r2 = summary(reg.aux)$r.squared
n = nobs(reg.aux)
(teststat = n * r2)
(pvalue = 1 - pchisq(teststat, 1))
```
