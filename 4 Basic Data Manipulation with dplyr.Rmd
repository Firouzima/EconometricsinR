---
title: "4 Basic Data Manipulation with dplyr"
author: "Mohammadamin Firouzi"
date: "2025-02-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Basic data manipulation with dplyr

#### World Bank’s World Development Indicators:

```{r message=FALSE, warning=FALSE}

# install.packages("WDI")
library("WDI")

WDIsearch('gdp')

gdpc = WDI(indicator = c("NY.GDP.PCAP.CD"), start = 1960, end = 2020)

head(gdpc)
tail(gdpc)
View(gdpc)
```

```{r message=FALSE, warning=FALSE}

# install.packages("dplyr")
library("dplyr")
```

#### distinct: finds all the unique rows in a dataset:

```{r message=FALSE, warning=FALSE}

distinct(gdpc, country)
distinct(gdpc, year)
```

#### count: find the number of occurrences:

```{r message=FALSE, warning=FALSE}

count(gdpc, country)
```

#### filter: only Iran data:

```{r message=FALSE, warning=FALSE}

Iran = filter(gdpc, iso3c == "IRN")
View(Iran)
Turkey_and_Germany = filter(gdpc, iso3c == "DEU" | iso3c == "TUR")
Turkey_and_Germany_1 = filter(gdpc, iso3c %in% c("DEU", "TUR"))
View(Turkey_and_Germany)
View(Turkey_and_Germany_1)
```

#### Rename variable:

```{r message=FALSE, warning=FALSE}

Iran = rename(Iran, gdpercapita = NY.GDP.PCAP.CD)
```

#### Select relevant variables:

```{r message=FALSE, warning=FALSE}

Iran = select(Iran, country, year, gdpercapita)
```

#### order by year:

```{r message=FALSE, warning=FALSE}

Iran = arrange(Iran, year) # ascending
Iran = arrange(Iran, desc(year)) # descending

# Missing values are always sorted at the end.
```

#### Add New Variables with mutate():

```{r message=FALSE, warning=FALSE}

elec = WDI(indicator = 'EG.USE.ELEC.KH.PC', start = 1960, end = 2020)
elec_iran = filter(elec, iso3c == 'IRN')
elec_iran = rename(elec_iran, elecpercapita = EG.USE.ELEC.KH.PC)
elec_iran = select(elec_iran, year, elecpercapita)
View(elec_iran)

Iran = mutate(Iran, elec = elec_iran$elecpercapita)
View(Iran)
```

Graph:

```{r message=FALSE, warning=FALSE}

library("ggplot2")
ggplot(Iran, aes(x = year, y = gdpercapita)) +
  geom_line(color = 'blue', linewidth = 1) +
  theme_light() +
  labs(title = "Gross Domestic Product per capita in Iran",
       caption = "Source = World Bank: World Development Indicators",
       x = "Year",
       y = 'GDP per capita (current US$)')
```

#### Alternative: using pipes

```{r message=FALSE, warning=FALSE}

Iran_dplyr = gdpc |>
  filter(iso3c == "IRN") |>
  rename(gdpercapita = NY.GDP.PCAP.CD) |>
  select(country, year, gdpercapita) |>
  arrange(desc(year))

View(Iran)
View(Iran_dplyr)
```

#### Group and summarize using pipes:

```{r message=FALSE, warning=FALSE}

Turkey_and_Germany |>
  group_by(iso3c) |>
  summarize(
    avg_gdpp = mean(NY.GDP.PCAP.CD)
    )

gdpc |>
  group_by(country) |>
  summarize(
    avg_gdpc = mean(NY.GDP.PCAP.CD, na.rm = TRUE)
  )

gdpc |>
  group_by(country) |>
  summarize(
    avg_gdpc = mean(NY.GDP.PCAP.CD, na.rm = TRUE),
    n = n()
  )
```

### More advanced data manipulation:

```{r message=FALSE, warning=FALSE}

le_data = WDI(indicator=c("SP.DYN.LE00.FE.IN"), start = 1960, end = 2020) |>
  rename(le = SP.DYN.LE00.FE.IN) |>
  select(country ,year, le)
View(le_data)

countryinfo = as.data.frame(WDI_data$country, stringsAsFactors = FALSE) |>
  select(country, income)
View(countryinfo)
```

Our next challenge is to combine these two data sets. We want to keep le_data and add the respective income classification by country from countryinfo. This is exactly what dplyr’s function left_join does.

```{r message=FALSE, warning=FALSE}

le_data = left_join(le_data, countryinfo, by = 'country')
View(le_data)

#Alternative:

countryinfo = as.data.frame(WDI_data$country, stringsAsFactors = FALSE) |>
  select(country, income)

le_data = WDI(indicator=c("SP.DYN.LE00.FE.IN"), start = 1960, end = 2020) |>
  rename(le = SP.DYN.LE00.FE.IN) |>
  select(country ,year, le) |>
  left_join(countryinfo, by = 'country')
```

There are more functions to combine data sets: right_join keeps the rows of the second data frame, inner_join keeps only rows that exist in both data sets, and full_join keeps all rows that exist in any of the data sets.

Now we want to calculate the average life expectancy over all countries that share the same income classification, separately by year. Within the tidyverse, dplyr offers the function summarize. The structure is

```{r message=FALSE, warning=FALSE}

summarise(le_data, le_avg = mean(le, na.rm = TRUE))
```

#### Summarize by country and year:

```{r message=FALSE, warning=FALSE}

meandata = le_data |>
  filter(income != "Aggregates") |>
  filter(income != "Not classified") |>
  group_by(income, year) |>
  summarise(le_avg = mean(le, na.rm = TRUE)) |>
  ungroup()

View(meandata)
```

na.rm removes missing values.

Graph:

```{r message=FALSE, warning=FALSE}

ggplot(meandata, aes(x = year, y = le_avg, color = income)) +
  geom_line(linewidth = 0.75) +
  theme_light() +
  labs(title = "Life expectancy of women",
       caption = "Source: World bank, WDI",
       x = "Year",
       y = "Average life expectancy by years",
       color = "Income level")
ggsave("le.pdf")
```
